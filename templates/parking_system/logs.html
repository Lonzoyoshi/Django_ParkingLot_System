<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统日志 - 智能停车场</title>
    <!-- 使用可靠的 CDN 源 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .log-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }

        .badge {
            font-size: 0.9em;
            padding: 0.5em 0.8em;
        }

        .clear-logs-btn {
            transition: all 0.3s ease;
        }

        .clear-logs-btn:hover {
            transform: scale(1.05);
        }

        .table th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        /* 按钮样式 */
        .btn {
            border-radius: 20px; /* 圆角半径 */
            padding: 0.4rem 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* 返回按钮样式 */
        .btn-back {
            color: #fff;
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .btn-back:hover {
            color: #fff;
            background-color: #2e59d9;
            border-color: #2653d4;
        }

        /* 清空按钮样式 */
        .btn-clear {
            color: #fff;
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-clear:hover {
            color: #fff;
            background-color: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 rounded-3 shadow">
        <div class="container-fluid">
            <a href="{% url 'manage' %}" class="btn btn-light btn-sm me-3">
                <i class="fas fa-arrow-left me-1"></i> 返回
            </a>
            <span class="navbar-brand">
                <i class="fas fa-history me-2"></i>
                系统日志
            </span>
            <button class="btn btn-danger clear-logs-btn" onclick="clearLogs()">
                <i class="fas fa-trash-alt me-1"></i>
                清空日志
            </button>
        </div>
    </nav>

    <!-- 日志内容 -->
    <div class="log-container">
        <!-- 筛选器 -->
        <div class="mb-4">
            <select class="form-select" onchange="window.location.href='?type=' + this.value">
                <option value="">全部类型</option>
                {% for type_code, type_name in operation_types %}
                    <option value="{{ type_code }}" {% if current_type == type_code %}selected{% endif %}>
                        {{ type_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- 日志表格 -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>操作时间</th>
                    <th>操作类型</th>
                    <th>用户</th>
                    <th>IP地址</th>
                    <th>描述</th>
                </tr>
                </thead>
                <tbody>
                {% for log in logs %}
                    <tr>
                        <td>{{ log.created_time|date:"Y-m-d H:i:s" }}</td>
                        <td>
            <span class="badge bg-{% if log.operation_type == 'LOGIN' %}success{% elif log.operation_type == 'ERROR' %}danger{% else %}primary{% endif %}">
                {{ log.get_operation_type_display }}
            </span>
                        </td>
                        <td>{{ log.user }}</td>
                        <td>{{ log.ip_address }}</td>
                        <td>{{ log.operation_detail }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">暂无日志记录</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页器 -->
        {% if logs.paginator.num_pages > 1 %}
            <nav>
                <ul class="pagination justify-content-center">
                    {% if logs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if current_type %}&type={{ current_type }}{% endif %}">首页</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page=

                                    {{ logs.previous_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}">上一页</a>
                        </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">第 {{ logs.number }}/{{ logs.paginator.num_pages }} 页</span>
                    </li>

                    {% if logs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page=

                                    {{ logs.next_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}">下一页</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page=

                                    {{ logs.paginator.num_pages }}{% if current_type %}&type={{ current_type }}{% endif %}">末页</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
</div>

<!-- JavaScript 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function clearLogs() {
        if (confirm('确定要清空所有日志记录吗？此操作不可恢复！')) {
            fetch('{% url "clear_logs" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('清空日志失败: ' + data.message);
                    }
                });
        }
    }

    function getCookie(name) {
        let value = `; ${document.cookie}`;
        let parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
</script>
</body>
</html>